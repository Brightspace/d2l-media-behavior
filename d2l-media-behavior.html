<link rel="import" href="../iron-range-behavior/iron-range-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>
	var MediaBehaviorImpl = {
		properties: {
			src: {
				type: String,
				value: ''
			},
			type: String,
			autoLoad: {
				type: Boolean,
				value: false
			},
			currentTime: {
				type: Number,
				value: 0,
				notify: true
			},
			duration: {
				type: Number,
				value: 0
			},
			requestSrc: {
				type: Boolean,
				value: false
			},
			volume: {
				type: Number,
				value: 1.0,
				observer: '_volumeChanged'
			}
		},

		observers: [
			'_srcChanged(src, type, requestSrc)'
		],

		listeners: {
			'media.loadedmetadata': '_onCanPlay',
			'media.playing': '_onPlaying',
			'media.pause': '_onPause',
			'media.ended': '_onEnd',
			'media.error': '_onError'
		},

		ready: function() {
			this._resetPlayer();
			var media = this.$.media;
			media.volume = this.volume;
		},

		_srcChanged: function(src, type, requestSrc) {
			this.canBePlayed = false;
			this.startedLoad = false;

			if (!this.mediaUrlRequest) {
				var mediaUrlRequest = document.createElement('iron-ajax');
				mediaUrlRequest.contentType = 'application/json';
				mediaUrlRequest.handleAs = 'json';
				mediaUrlRequest.method = 'get';
				this.mediaUrlRequest = mediaUrlRequest;
			}

			if (requestSrc && this.autoLoad) {
				this.mediaUrlRequest.url = src;
				this._requestMediaUrl(false);
			} else if (!requestSrc) {
				this._resetPlayer();
				this._addSource(src, type);
			}
		},

		_resetPlayer: function() {
			this.isPlaying = false;
			this.ended = false;
			this.percentComplete = 0;
			this.seeking = false;
			this.immediateValue = 0;
			this.currentTime = 0;
			this.startedLoad = false;
			this.firstPlay = true;
		},

		_volumeChanged: function(volume) {
			this.$.media.volume = volume;
		},

		_requestMediaUrl: function(playAfterLoad) {
			var self = this;

			return this.mediaUrlRequest.generateRequest().completes
				.then(function(event) {
					self._addSource(event.detail.response.url, event.detail.response.type);
					this.startedLoad = true;
					self.$.media.load();

					if (playAfterLoad) {
						return this._playHandler(self.$.media.play());
					}
				});
		},

		_addSource: function(src, type) {
			if (src) {
				var source = document.createElement('source');
				source.src = src;
				source.type = type;
				source.addEventListener('error', error => {
					this.sourceError = true;
				});
				Polymer.dom(this.$.media).appendChild(source);
			}
		},

		_playPause: function(event) {
			if (event) {
				event.preventDefault();
			}

			var media = this.$.media;
			if (this.canBePlayed) {
				return this.isPlaying ? media.pause() : this._playHandler(media.play());
			} else if (!this.autoLoad) {
				if (this.requestSrc) {
					this._requestMediaUrl(true);
				} else if (!this.startedLoad) {
					this.startedLoad = true;
					media.load();
					return this._playHandler(media.play());
				}
			}
		},

		_playHandler: function(playPromise) {
			if (playPromise) {
				playPromise.catch(error => { this.sourceError = true; });
			}
		},

		_getFormattedTime: function() {
			return this._formatTime(this.firstPlay ? this.duration : this._getImmediateTime());
		},

		_getImmediateTime: function() {
			return this.duration * (this.immediateValue / 100);
		},

		_formatTime: function(seconds) {
			if (seconds === 0) {
				return '0:00';
			}

			var minutes = Math.floor(seconds / 60);
			var secondsLeft = String(Math.floor(seconds % 60));
			return minutes + ':' + (secondsLeft.length < 2 ? '0' + secondsLeft : secondsLeft);
		},

		_onSeekStart: function() {
			this.seeking = true;
		},

		_onSeekEnd: function() {
			if (this.seeking) {
				this._updatePlayPosition(this._getImmediateTime());
				this.seeking = false;
			}
		},

		_onCanPlay: function() {
			this.canBePlayed = true;

			var media = this.$.media;
			this.duration = media.duration;
		},

		_onPlaying: function() {
			this.firstPlay = false;
			this.ended = false;
			this.isPlaying = true;
			this._startProgressTimer();
		},

		_onPause: function() {
			this.isPlaying = false;
		},

		_onEnd: function() {
			this.ended = true;
			this.isPlaying = false;
		},

		_onError: function() {

		},

		_updatePlayPosition: function(newTime) {
			var media = this.$.media;
			this.currentTime = media.currentTime = newTime;
		},

		_startProgressTimer: function() {
			var self = this;

			if (this.progressTimer) {
				clearInterval(this.progressTimer);
			}

			this.progressTimer = setInterval(function() {
				var media = self.$.media;
				if (self.isPlaying) {
					self.currentTime = media.currentTime;

					if (!self.seeking) {
						self.percentComplete = (self.currentTime / self.duration) * 100;
					}
				} else {
					clearInterval(self.progressTimer);
				}
			}, 60);
		},

		_getPreload: function() {
			return this.autoLoad ? 'auto' : 'none';
		}
	};

	D2LMediaBehavior = [Polymer.IronRangeBehavior, MediaBehaviorImpl];
</script>
